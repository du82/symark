<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}} | {{site_name}}</title>
    <link rel="stylesheet" href="styles.css">
    <meta name="description" content="{{meta_description}}">
    
    <!-- OpenGraph Tags -->
    <meta property="og:title" content="{{title}}">
    <meta property="og:description" content="{{meta_description}}">
    <meta property="og:type" content="article">
    <meta property="og:url" content="{{og_url}}">
    <meta property="og:site_name" content="{{site_name}}">
    <meta property="og:locale" content="en_US">
    <meta property="og:image" content="{{og_image}}">
    <meta property="article:published_time" content="{{og_published_time}}">
    <meta property="article:modified_time" content="{{og_modified_time}}">
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const menuButton = document.querySelector('.header-icon[title="Table of Contents"]');
            const tocSidebar = document.getElementById('toc-sidebar');
            const contentWrapper = document.querySelector('.content-wrapper');
            const overlay = document.getElementById('toc-overlay');
            const tocToggleBtn = document.getElementById('toc-auto-hide-toggle');
            let keepTocOpen = false;
            
            // Add animation delay to TOC items for staggered effect
            function setupTocAnimation() {
                const tocItems = document.querySelectorAll('.toc-item');
                tocItems.forEach((item, index) => {
                    item.style.setProperty('--item-index', index);
                });
            }
            
            // Setup TOC animation on page load
            setupTocAnimation();
            
            // Handle TOC item clicks to close sidebar on mobile only
            function setupTocItemClickHandlers() {
                const tocLinks = document.querySelectorAll('.toc-link');
                const isMobile = window.innerWidth <= 768;
                
                tocLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        // Only close if on mobile or if not set to keep open
                        if (isMobile || !keepTocOpen) {
                            document.body.classList.remove('toc-open');
                            menuButton.setAttribute('aria-expanded', 'false');
                            tocSidebar.setAttribute('aria-hidden', 'true');
                            
                            if (isMobile) {
                                document.body.style.overflow = '';
                            }
                        }
                        
                        // Add active class to the clicked item
                        document.querySelectorAll('.toc-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        this.closest('.toc-item').classList.add('active');
                    });
                });
            }
            
            setupTocItemClickHandlers();
            
            // Track active TOC section based on scroll position
            function updateActiveTocItem() {
                const headings = Array.from(document.querySelectorAll('h2, h3'));
                const tocItems = document.querySelectorAll('.toc-item');
                
                if (headings.length === 0 || tocItems.length === 0) return;
                
                // Get current scroll position with a small offset
                const scrollPos = window.scrollY + 100;
                
                // Find the current heading
                let currentHeadingIndex = -1;
                for (let i = 0; i < headings.length; i++) {
                    if (headings[i].offsetTop > scrollPos) {
                        break;
                    }
                    currentHeadingIndex = i;
                }
                
                // Remove active class from all TOC items
                tocItems.forEach(item => item.classList.remove('active'));
                
                // If we found a heading, highlight its TOC item
                if (currentHeadingIndex >= 0) {
                    const currentHeading = headings[currentHeadingIndex];
                    const currentHeadingId = currentHeading.id;
                    
                    // Find TOC item with link to this heading
                    const activeTocItem = document.querySelector(`.toc-item a[href="#${currentHeadingId}"]`);
                    if (activeTocItem) {
                        activeTocItem.closest('.toc-item').classList.add('active');
                    }
                }
            }
            
            // Add scroll event listener with throttling
            let scrollTimeout;
            window.addEventListener('scroll', function() {
                if (!scrollTimeout) {
                    scrollTimeout = setTimeout(function() {
                        updateActiveTocItem();
                        scrollTimeout = null;
                    }, 100);
                }
            });
            
            // Update active TOC item on page load
            window.addEventListener('load', updateActiveTocItem);
            
            // Update on window resize
            window.addEventListener('resize', function() {
                setupTocItemClickHandlers();
                updateActiveTocItem();
                
                // Reset body overflow on large screens
                if (window.innerWidth > 768) {
                    document.body.style.overflow = '';
                } else if (document.body.classList.contains('toc-open')) {
                    document.body.style.overflow = 'hidden';
                }
            });
            
            // Toggle TOC button handler
            tocToggleBtn.addEventListener('click', function() {
                keepTocOpen = !keepTocOpen;
                this.textContent = keepTocOpen ? 'Auto-hide sidebar' : 'Keep sidebar open';
                this.classList.toggle('active', keepTocOpen);
                
                // Save preference to localStorage
                localStorage.setItem('keepTocOpen', keepTocOpen ? 'true' : 'false');
            });
            
            // Load preference from localStorage
            if (localStorage.getItem('keepTocOpen') === 'true') {
                keepTocOpen = true;
                tocToggleBtn.textContent = 'Auto-hide sidebar';
                tocToggleBtn.classList.add('active');
            }
            
            menuButton.addEventListener('click', function(e) {
                e.preventDefault();
                const isOpen = document.body.classList.toggle('toc-open');
                
                // Update ARIA attributes for accessibility
                menuButton.setAttribute('aria-expanded', isOpen);
                tocSidebar.setAttribute('aria-hidden', !isOpen);
                
                // Announce to screen readers
                const status = isOpen ? 'Table of contents opened' : 'Table of contents closed';
                
                // Only prevent scrolling on mobile screens
                if (isOpen) {
                    if (window.innerWidth <= 768) {
                        document.body.style.overflow = 'hidden';
                    }
                    
                    // Reset animation by removing and re-adding classes
                    const tocItems = document.querySelectorAll('.toc-item');
                    tocItems.forEach(item => {
                        item.style.animation = 'none';
                        item.offsetHeight; // Force reflow
                        item.style.animation = '';
                    });
                    
                    // Update active TOC item
                    updateActiveTocItem();
                } else {
                    if (window.innerWidth <= 768) {
                        document.body.style.overflow = '';
                    }
                }
            });
            
            overlay.addEventListener('click', function() {
                document.body.classList.remove('toc-open');
                menuButton.setAttribute('aria-expanded', 'false');
                tocSidebar.setAttribute('aria-hidden', 'true');
                document.body.style.overflow = '';
            });
            
            // Allow keyboard navigation
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && document.body.classList.contains('toc-open')) {
                    // Only close if not set to keep open or if on mobile
                    if (!keepTocOpen || window.innerWidth <= 768) {
                        document.body.classList.remove('toc-open');
                        menuButton.setAttribute('aria-expanded', 'false');
                        tocSidebar.setAttribute('aria-hidden', 'true');
                        
                        // Only reset overflow if on mobile
                        if (window.innerWidth <= 768) {
                            document.body.style.overflow = '';
                        }
                    }
                }
            });
        });
    </script>
</head>
<body>
    <header class="site-header">
        <div class="header-content">
            <a href="index.html" class="site-title">{{site_name}}</a>
            <div class="header-icons">
                <a href="#" class="header-icon" title="Search">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </a>
                <a href="#" class="header-icon" title="Table of Contents" aria-label="Toggle table of contents" aria-controls="toc-sidebar" aria-expanded="false">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </a>
            </div>
        </div>
    </header>
    
    <div id="toc-overlay" role="button" aria-label="Close table of contents"></div>
    <div id="toc-sidebar" role="navigation" aria-label="Table of contents" aria-hidden="true">
        <div class="toc-header">
            <h2>Table of Contents</h2>
            <button class="toc-close-btn" aria-label="Close table of contents" onclick="
                const keepOpenState = localStorage.getItem('keepTocOpen') === 'true';
                if(!keepOpenState || window.innerWidth <= 768) {
                    document.body.classList.remove('toc-open');
                    if(window.innerWidth <= 768) document.body.style.overflow = '';
                    document.querySelector('.header-icon[aria-controls=\'toc-sidebar\']').setAttribute('aria-expanded', 'false');
                    document.getElementById('toc-sidebar').setAttribute('aria-hidden', 'true');
                }
            ">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <nav class="toc-nav">
            <ul class="toc-list">
                {{table_of_contents}}
            </ul>
            <div class="toc-footer">
                <small>Click headings to navigate</small>
                <div class="toc-toggle">
                    <button id="toc-auto-hide-toggle" class="toc-toggle-btn">
                        Keep sidebar open
                    </button>
                </div>
            </div>
        </nav>
    </div>
    
    <div class="content-wrapper">
        <div class="container">
            {{back_navigation}}
            <main>
            <div class="article-header">
                {{#header_image}}
                <div class="header-image" style="{{header_image}}"></div>
                {{/header_image}}
                <div class="title-container">
                    <h1 class="article-title">{{title}}</h1>
                </div>
                <div class="article-meta tag-cloud">
                    {{note_meta}}
                </div>
            </div>

            <div class="article-content">
                {{content}}
            </div>
        </main>
    </div>
    </div>
</body>
</html>
